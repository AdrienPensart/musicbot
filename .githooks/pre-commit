#!/bin/sh

set -e
trap '[ $? -eq 0 ] && exit 0 || echo "$0 FAILED"' EXIT

echo "updating poetry deps..."
poetry update
poetry export -f requirements.txt -o requirements.txt --without-hashes
sed -i '/extra-index-url/d' requirements.txt
sed -i '/^$/d' requirements.txt

poetry export --dev -f requirements.txt -o requirements-dev.txt --without-hashes
sed -i '/extra-index-url/d' requirements-dev.txt
sed -i '/^$/d' requirements-dev.txt
echo "setup.py generation..."
poetry run dephell convert
git add setup.py poetry.lock requirements.txt requirements-dev.txt

echo "linting..."
poetry run pylint musicbot tests

echo "type checking..."
poetry run pytype musicbot -j auto -k

kernel=`uname -r`
case "$kernel" in
*microsoft*) echo "No unit testing because docker not available" ;;
*       )
    echo "Running unit tests"
    poetry run pytest
    poetry run coverage-badge -f -o doc/coverage.svg
    git add doc/coverage.svg
    ;;
esac

echo "rst-linting pass 1..."
poetry run rst-lint doc/help.rst
echo "doc generation..."
poetry run doc/gen.py > README.rst
echo "rst-linting pass 2..."
poetry run rst-lint README.rst
git add README.rst

exit 0
